HPCToolkit Database File Formats
================================

A full HPCToolkit database consists of the following files and directories:

    database/
    |-- FORMATS.md:     This file
    |-- experiment.xml: Properties of the measured execution.
    |-- profile.db:     Performance measurements arranged by application thread
    |-- cct.db:         Performance measurements arranged by calling context
    |-- trace.db:       Time-centric execution traces
    `-- src/:           Relevant application source files

The following sections go into more detail for each of these files.

### Glossary ###
- **Application Thread**: General term for a serial execution of the
  application, whether it executed on the CPU or an external accelerator (GPU)
  or otherwise. Examples include standard PThreads and CUDA streams.
- **Profile**: The set of performance measurements associated with a single
  application thread.
- **Metric**: A performance-related value that is measured by sampling the
  application, enabled by passing an `-e` argument to `hpcrun`. Examples
  include `REALTIME` (wallclock time spent), `cycles` (CPU cycles spent) and
  `GPUOPS` (time spent in GPU operations).

`experiment.xml` version 4.0
----------------------------

The `experiment.xml` is an XML file listing various general properties of the
application execution, such as enabled metrics and application binaries. Most
importantly it lists the entire measured calling context tree.

The `experiment.xml` has the following structure:
```xml
<?xml version="1.0"?>
<HPCToolkitExperiment version="<database format version, currently 4.0>">
    </Header n="<database title>">
    <SecCallPathProfile i="0" n="<database title>">
        <SecHeader>
            <IdentifierNameTable> ... </IdentifierNameTable>
            <MetricTable> ........... </MetricTable>
            <MetricDBTable> ......... </MetricDBTable>
            <TraceDBTable> .......... </TraceDBTable>
            <LoadModuleTable> ....... </LoadModuleTable>
            <FileTable> ............. </FileTable>
            <ProcedureTable> ........ </ProcedureTable>
        </SecHeader>
        <SecCallPathProfileData> ... </SecCallPathProfileData>
    </SecCallPathProfile>
</HPCToolkitExperiment>
```

### `<IdentifierNameTable>` ###

This tag has the following structure:
```xml
<IdentifierNameTable>
    <Identifier i="<identifier kind>" n="<identifier name>"/>
    ...
</IdentifierNameTable>
```

Each of these `<Identifier>` entries maps a `kind` potentially used in the
[identifier tuple](#hierarchical-identifier-tuple) for an application thread
to a human-readable name. This name is used by HPCViewer to convert an
identifier tuple into a human-readable identifier for the application thread.

### `<MetricTable>` ###

The `<MetricTable>` tag has the following structure:
```xml
<MetricTable>
    <Metric
      i="<identifier>" o="<ordering number>"
      n="<human-readable name>"
      md="<human-readable description>"
      v="<type>" [t="<subtype>"]
      [partner="<identifier for partner Metric tag>"]
      show="<visibility flag>"
      show-percent="<whether to show percentages (1) or not (0)>"
      fmt="<printf-style format to present >"
      >
        <MetricFormula t="<formula type>" frm="<formala, see below>"/>
        ...
    </Metric>
    ...
</MetricTable>
```

Each `<Metric>` tag represents a single column in HPCViewer's performance value
presentation ("Profile" tab).

`<visibility flag>` may be one of the following values:
 - `0`: hidden by default, can be shown on user request
 - `1`: shown by default
 - `2`: shown by default, only inclusive values
 - `3`: shown by default, only exclusive values
 - `4`: invisible, internal column used for calculations

### etc. ###

`profile.db` version 4.0
------------------------

The `profile.db` is a binary file containing the performance analysis results
generated by `hpcprof`, arranged by application thread and in a compact sparse
representation. Once an application thread is chosen, the analysis result for
a particular calling context can be obtained through a simple binary search.

The `profile.db` has the following overall structure:

    |--- Header ----------------------------------| Offset (dec hex), field size
    | Magic identifier ("HPCPROF-tmsdb___")       |  0  0, 16 bytes
    | Version (major, minor. Currently 4.0)       | 16 10,  2 bytes
    | Number of profiles (num_prof)               | 18 12,  4 bytes
    | Number of sections (num_sec)                | 22 16,  2 bytes
    | Profile Info section size (pi_size)         | 24 18,  8 bytes
    | Profile Info section offset (pi_ptr)        | 32 20,  8 bytes
    | Identifier Tuple section size (idt_size)    | 40 28,  8 bytes
    | Identifier Tuple section offset (idt_ptr)   | 48 30,  8 bytes
    |                                             |
    |--- Profile Info section --------------------| (pi_ptr), (pi_size)
    | Profile Info index 0 (see below)            |  0  0, 52 bytes
    | Profile Info index 1                        | 52 34, 52 bytes
    | ...                                         | ...
    | Profile Info index (num_prof)               | ** **, 52 bytes
    |                                             |
    |--- Identifier Tuple section ----------------| (idt_ptr), (idt_size)
    | Hierarchical Identifier Tuple (see below)   |  0  0, ** bytes
    | ...                                         | ...
    |                                             |
    |--- Sparse Metric section -------------------| ** **, **
    | Profile Sparse Value Block (see below)      | ** **, **
    | ...                                         | ...
    |                                             |
    |---------------------------------------------|
    | Magic footer ("PROFDBft" or "tfBDFORP")     | ** **, 8 bytes
    |---------------------------------------------| EOF

### Profile Info ###

### Hierarchical Identifier Tuple ###

Each identifier tuple has the following structure:

    |----------------------------------------------| 2 + 10*(len) bytes
    | Number of identifier elements (len)          |  0  0, 2 bytes
    | {                                            |  2  2
    |   Identifier kind                            | +  0  0, 2 bytes
    |   Identifier value                           | +  2  2, 8 bytes
    | } ...                                        |

An element's `value` is interpreted based on its `kind`, as one of:
 - `1` "Node": The individual compute node executed on. `value` is the value
   returned by a call to `gethostid()`.
 - `2` "Rank": The MPI rank assigned to the process. `values` is the assigned
   rank index.
 - `3` "Thread": Unique CPU thread identifier within the process. `value` is a
   unique thread index.
 - `4` "GPU Device":
 - `5` "GPU Context":
 - `6` "GPU Stream":
 - `7` "Core":

### Profile Sparse Value Block ###

`cct.db` version 4.0
--------------------

`trace.db` version 4.0
----------------------

    |--- Header ----------------------------------| Offset (dec hex), field size
    | Magic identifier ("HPCPROF-tracedb_")       |  0  0, 16 bytes
    | Version (major, minor. Currently 4.0)       | 16 10,  2 bytes
    | Number of trace lines (num_traces)          | 18 12,  4 bytes
    | Number of sections (num_sec)                | 22 16,  2 bytes
    | Trace Header section size (hdr_size)        | 24 18,  8 bytes
    | Trace Header section offset (hdr_ptr)       | 32 20,  8 bytes
    |                                             |
    |--- Trace Header section --------------------| (hdr_ptr), (hdr_size)
    | Trace Header index 0 (see below)            |  0  0, 22 bytes
    | Trace Header index 1                        | 22 16, 22 bytes
    | ...                                         | ...
    | Trace Header index (num_traces)             | ** **, 22 bytes
    |                                             |
    |--- Trace Line section -000------------------| ** **, **
    | Trace Line (see below)                      | ** **, **
    | ...                                         | ...
    |                                             |
    |---------------------------------------------|
    | Magic footer ("TRACDBft" or "tfBDCART")     | ** **, 8 bytes
    |---------------------------------------------| EOF
    
### Trace Header ###

    |------------------------------------------------| 22 bytes
    | Index of Profile Info (in profile.db)          |   0  0, 4 bytes
    | Trace type                                     |   4  4, 2 bytes
    | Offset of Trace Line start (line_ptr)          |   6  6, 8 bytes
    | Offset of Trace Line one-after-end (line_end)  |  14  e, 8 bytes

### Trace Line ###

    |--------------------------------------------------| (line_end)-(line_ptr) bytes
    | Sample {                                         |  0  0
    |   Timestamp (nanoseconds since epoch)            | + 0  0, 8 bytes
    |   Sample calling context id (in experiment.xml)  | + 8  8, 4 bytes
    | } ...                                            |
